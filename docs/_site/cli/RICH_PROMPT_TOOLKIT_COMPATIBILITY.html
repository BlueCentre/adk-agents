<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(8)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(8) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(8) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(8) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Rich + prompt_toolkit Compatibility | DevOps Agent Documentation</title> <meta name="generator" content="Jekyll v3.9.5" /> <meta property="og:title" content="Rich + prompt_toolkit Compatibility" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="The DevOps Agent is a sophisticated AI assistant engineered to empower developers and DevOps engineers across the full software development lifecycle. This documentation provides guidance on its features, usage, and contribution." /> <meta property="og:description" content="The DevOps Agent is a sophisticated AI assistant engineered to empower developers and DevOps engineers across the full software development lifecycle. This documentation provides guidance on its features, usage, and contribution." /> <link rel="canonical" href="/cli/RICH_PROMPT_TOOLKIT_COMPATIBILITY.html" /> <meta property="og:url" content="/cli/RICH_PROMPT_TOOLKIT_COMPATIBILITY.html" /> <meta property="og:site_name" content="DevOps Agent Documentation" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Rich + prompt_toolkit Compatibility" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"The DevOps Agent is a sophisticated AI assistant engineered to empower developers and DevOps engineers across the full software development lifecycle. This documentation provides guidance on its features, usage, and contribution.","headline":"Rich + prompt_toolkit Compatibility","url":"/cli/RICH_PROMPT_TOOLKIT_COMPATIBILITY.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> DevOps Agent Documentation </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/architecture.html" class="nav-list-link">Architecture</a></li><li class="nav-list-item"><a href="/features.html" class="nav-list-link">Features</a></li><li class="nav-list-item"><a href="/usage.html" class="nav-list-link">Usage Guide</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in CLI Documentation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/cli/README.html" class="nav-list-link">CLI Documentation</a><ul class="nav-list"><li class="nav-list-item"><a href="/cli/TEXTUAL_CLI.html" class="nav-list-link">Textual CLI Guide</a></li><li class="nav-list-item"><a href="/cli/INPUT_PANE_GUIDE.html" class="nav-list-link">Input Pane Guide</a></li><li class="nav-list-item"><a href="/cli/STYLES.html" class="nav-list-link">UI Component Styling</a></li></ul></li><li class="nav-list-item"><a href="/contributing.html" class="nav-list-link">Contributing</a></li><li class="nav-list-item"><a href="/cli/MARKDOWN_RENDERING.html" class="nav-list-link">Markdown Rendering in Textual CLI</a></li><li class="nav-list-item"><a href="/cli/RICH_PROMPT_TOOLKIT_COMPATIBILITY.html" class="nav-list-link">Rich + prompt_toolkit Compatibility</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search DevOps Agent Documentation" aria-label="Search DevOps Agent Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/BlueCentre/adk-agents" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="rich--prompt_toolkit-compatibility"> <a href="#rich--prompt_toolkit-compatibility" class="anchor-heading" aria-labelledby="rich--prompt_toolkit-compatibility"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Rich + prompt_toolkit Compatibility </h1> <h2 id="the-problem-"> <a href="#the-problem-" class="anchor-heading" aria-labelledby="the-problem-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Problem 🚫 </h2> <p>Rich and prompt_toolkit don’t work well together out of the box:</p> <ul> <li><strong>Rich</strong> uses ANSI escape codes and special markup for beautiful terminal output</li> <li><strong>prompt_toolkit</strong> has its own text rendering system with buffers and layout management</li> <li><strong>Conflict</strong>: Rich’s formatting codes appear as messy, unrendered text in prompt_toolkit buffers</li> </ul> <h3 id="before-messy-output"> <a href="#before-messy-output" class="anchor-heading" aria-labelledby="before-messy-output"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Before (Messy Output): </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[20:43:22] 🤖 devops_agent: [bold green]Hello![/bold green] How can I assist you today?
╭───────────────────────────────────────── 🧠 Model Usage (with Thinking) ─────────────────────────────────────────╮
│ Token Usage: Prompt: 2475, [cyan]Thinking: 33[/cyan], Output: 9, Total: 2517                                   │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
</code></pre></div></div> <h3 id="after-clean-output"> <a href="#after-clean-output" class="anchor-heading" aria-labelledby="after-clean-output"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> After (Clean Output): </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[20:43:22] 🤖 devops_agent: Hello! How can I assist you today?
Token Usage: Prompt: 2475, Thinking: 33, Output: 9, Total: 2517
</code></pre></div></div> <h2 id="the-solution-"> <a href="#the-solution-" class="anchor-heading" aria-labelledby="the-solution-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Solution ✅ </h2> <h3 id="1-text-sanitization-in-textualcli"> <a href="#1-text-sanitization-in-textualcli" class="anchor-heading" aria-labelledby="1-text-sanitization-in-textualcli"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. <strong>Text Sanitization in TextualCLI</strong> </h3> <p>Added a <code class="language-plaintext highlighter-rouge">_add_to_output()</code> method that converts Rich content to plain text:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_add_to_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">""</span><span class="p">):</span>
    <span class="s">"""Add text to the output buffer, stripping Rich formatting."""</span>
    <span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
    
    <span class="c1"># Create a temporary console to render Rich content to plain text
</span>    <span class="n">string_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">temp_console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">string_io</span><span class="p">,</span> <span class="n">force_terminal</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="c1"># Try to render as Rich content, fall back to plain text
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">temp_console</span><span class="p">.</span><span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">clean_text</span> <span class="o">=</span> <span class="n">string_io</span><span class="p">.</span><span class="n">getvalue</span><span class="p">().</span><span class="n">rstrip</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># If Rich rendering fails, use plain text
</span>        <span class="n">clean_text</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%H:%M:%S"</span><span class="p">)</span>
    <span class="n">formatted_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">clean_text</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
    
    <span class="n">current_text</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_buffer</span><span class="p">.</span><span class="n">text</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">output_buffer</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">current_text</span> <span class="o">+</span> <span class="n">formatted_text</span>
    
    <span class="c1"># Auto-scroll to bottom
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">output_buffer</span><span class="p">.</span><span class="n">cursor_position</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_buffer</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div> <h3 id="2-ansi-code-stripping-function"> <a href="#2-ansi-code-stripping-function" class="anchor-heading" aria-labelledby="2-ansi-code-stripping-function"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. <strong>ANSI Code Stripping Function</strong> </h3> <p>Added <code class="language-plaintext highlighter-rouge">_strip_rich_markup()</code> to remove any remaining formatting:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_strip_rich_markup</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""Strip Rich markup and ANSI codes from text for clean prompt_toolkit display."""</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a console that outputs plain text
</span>        <span class="n">string_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">temp_console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">string_io</span><span class="p">,</span> <span class="n">force_terminal</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">legacy_windows</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="c1"># Print the text and capture plain output
</span>        <span class="n">temp_console</span><span class="p">.</span><span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">markup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">clean_text</span> <span class="o">=</span> <span class="n">string_io</span><span class="p">.</span><span class="n">getvalue</span><span class="p">().</span><span class="n">rstrip</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        
        <span class="c1"># Additional cleanup of any remaining ANSI codes
</span>        <span class="n">ansi_escape</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])'</span><span class="p">)</span>
        <span class="n">clean_text</span> <span class="o">=</span> <span class="n">ansi_escape</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">clean_text</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">clean_text</span>
        
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># Fallback: basic ANSI code removal
</span>        <span class="n">ansi_escape</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ansi_escape</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div></div> <h3 id="3-agent-response-processing"> <a href="#3-agent-response-processing" class="anchor-heading" aria-labelledby="3-agent-response-processing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. <strong>Agent Response Processing</strong> </h3> <p>Modified the agent response handler to clean text before display:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">_process_agent_responses</span><span class="p">(</span><span class="n">agent_gen</span><span class="p">,</span> <span class="n">cli</span><span class="p">):</span>
    <span class="s">"""Process agent responses and add them to the CLI output."""</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">agent_gen</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">text</span> <span class="p">:</span><span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">part</span><span class="p">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s">''</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">parts</span><span class="p">):</span>
                <span class="c1"># Filter out thought content to prevent duplication
</span>                <span class="n">filtered_text</span> <span class="o">=</span> <span class="n">_filter_thought_content</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">filtered_text</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="c1"># Strip any Rich markup/ANSI codes for clean prompt_toolkit display
</span>                    <span class="n">clean_text</span> <span class="o">=</span> <span class="n">_strip_rich_markup</span><span class="p">(</span><span class="n">filtered_text</span><span class="p">)</span>
                    <span class="n">cli</span><span class="p">.</span><span class="n">add_agent_output</span><span class="p">(</span><span class="n">clean_text</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">author</span><span class="p">)</span>
</code></pre></div></div> <h2 id="technical-approach-"> <a href="#technical-approach-" class="anchor-heading" aria-labelledby="technical-approach-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Technical Approach 🔧 </h2> <h3 id="two-stage-cleaning-process"> <a href="#two-stage-cleaning-process" class="anchor-heading" aria-labelledby="two-stage-cleaning-process"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Two-Stage Cleaning Process</strong> </h3> <ol> <li><strong>Rich Console Rendering</strong>: Use Rich’s own console to render markup to plain text</li> <li><strong>ANSI Code Removal</strong>: Strip any remaining escape sequences with regex</li> </ol> <h3 id="fallback-strategy"> <a href="#fallback-strategy" class="anchor-heading" aria-labelledby="fallback-strategy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Fallback Strategy</strong> </h3> <ul> <li>Primary: Rich console rendering with <code class="language-plaintext highlighter-rouge">force_terminal=False</code></li> <li>Fallback: Regex-based ANSI code removal</li> <li>Final: Raw text if all else fails</li> </ul> <h3 id="compatibility-layer"> <a href="#compatibility-layer" class="anchor-heading" aria-labelledby="compatibility-layer"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Compatibility Layer</strong> </h3> <p>The solution acts as a compatibility layer:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rich Formatted Text → Rich Console (plain) → ANSI Stripper → prompt_toolkit Buffer
     ↓                      ↓                    ↓                    ↓
[bold]Hello[/bold]   →   Hello   →   Hello   →   Clean Display
</code></pre></div></div> <h2 id="benefits-"> <a href="#benefits-" class="anchor-heading" aria-labelledby="benefits-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Benefits 🎉 </h2> <h3 id="for-users"> <a href="#for-users" class="anchor-heading" aria-labelledby="for-users"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>For Users</strong> </h3> <ul> <li>✅ <strong>Clean, readable output</strong> in the Textual CLI</li> <li>✅ <strong>No formatting artifacts</strong> or escape codes</li> <li>✅ <strong>Consistent appearance</strong> across different terminals</li> <li>✅ <strong>Preserved functionality</strong> of both Rich and prompt_toolkit</li> </ul> <h3 id="for-developers"> <a href="#for-developers" class="anchor-heading" aria-labelledby="for-developers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>For Developers</strong> </h3> <ul> <li>✅ <strong>Use Rich freely</strong> in agent code without compatibility concerns</li> <li>✅ <strong>Automatic conversion</strong> - no manual text processing needed</li> <li>✅ <strong>Backwards compatible</strong> - existing code continues to work</li> <li>✅ <strong>Error resilient</strong> - graceful fallbacks if conversion fails</li> </ul> <h2 id="configuration-options-️"> <a href="#configuration-options-️" class="anchor-heading" aria-labelledby="configuration-options-️"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuration Options 🛠️ </h2> <h3 id="console-width"> <a href="#console-width" class="anchor-heading" aria-labelledby="console-width"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Console Width</strong> </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp_console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">string_io</span><span class="p">,</span> <span class="n">force_terminal</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div></div> <ul> <li>Controls text wrapping in the output</li> <li>Adjustable based on terminal size</li> </ul> <h3 id="rich-features-disabled"> <a href="#rich-features-disabled" class="anchor-heading" aria-labelledby="rich-features-disabled"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Rich Features Disabled</strong> </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp_console</span><span class="p">.</span><span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">markup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <ul> <li>Disables Rich markup processing</li> <li>Disables syntax highlighting</li> <li>Ensures plain text output</li> </ul> <h3 id="ansi-escape-pattern"> <a href="#ansi-escape-pattern" class="anchor-heading" aria-labelledby="ansi-escape-pattern"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>ANSI Escape Pattern</strong> </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ansi_escape</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])'</span><span class="p">)</span>
</code></pre></div></div> <ul> <li>Comprehensive ANSI escape sequence matching</li> <li>Removes colors, cursor movements, formatting codes</li> </ul> <h2 id="usage-examples-"> <a href="#usage-examples-" class="anchor-heading" aria-labelledby="usage-examples-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Usage Examples 📝 </h2> <h3 id="before-messy"> <a href="#before-messy" class="anchor-heading" aria-labelledby="before-messy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Before (Messy)</strong> </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Agent Output: [bold red]Error:[/bold red] Connection failed
[33mWarning:[0m Retrying connection...
╭─ Status ─╮
│ [32m✓[0m │
╰──────────╯
</code></pre></div></div> <h3 id="after-clean"> <a href="#after-clean" class="anchor-heading" aria-labelledby="after-clean"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>After (Clean)</strong> </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Agent Output: Error: Connection failed  
Warning: Retrying connection...
Status: ✓
</code></pre></div></div> <h2 id="testing-"> <a href="#testing-" class="anchor-heading" aria-labelledby="testing-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Testing 🧪 </h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Test the clean output</span>
uv run agent run agents.devops <span class="nt">--tui</span>

<span class="c"># Should now display:</span>
<span class="c"># - Clean, readable text</span>
<span class="c"># - No ANSI escape codes</span>
<span class="c"># - No Rich markup artifacts</span>
<span class="c"># - Proper text wrapping</span>
</code></pre></div></div> <h2 id="future-enhancements-"> <a href="#future-enhancements-" class="anchor-heading" aria-labelledby="future-enhancements-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Future Enhancements 🚀 </h2> <ol> <li><strong>Configurable width</strong>: Auto-detect terminal width</li> <li><strong>Selective formatting</strong>: Preserve some basic formatting (bold, colors)</li> <li><strong>Rich integration</strong>: Use prompt_toolkit’s FormattedText for Rich-like styling</li> <li><strong>Performance optimization</strong>: Cache rendered text for repeated content</li> </ol><hr /> <p>This solution enables seamless integration between Rich’s powerful formatting capabilities and prompt_toolkit’s advanced UI features, giving you the best of both worlds! 🎯</p> </main> </div> </div> <div class="search-overlay"></div> </div> <script type="module"> import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.esm.min.mjs'; var config = {} ; mermaid.initialize(config); mermaid.run({ querySelector: '.language-mermaid', }); </script> </body> </html>
